{% extends 'base.html' %}

{% block title %}Liste des Patients{% endblock %}

{% block header %}Gestion des Patients{% endblock %}

{% block sidebar %}
    <a href="{% url 'admin_dashboard' %}" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out">
        <i class="fa-solid fa-gauge-high w-5 h-5"></i>
        <span>Tableau de bord</span>
    </a>
    <a href="{% url 'list_doctors' %}" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out">
        <i class="fa-solid fa-user-doctor w-5 h-5"></i>
        <span>Docteurs</span>
    </a>
    <a href="{% url 'list_patients' %}" class="flex items-center space-x-3 p-3 rounded-lg text-white bg-emerald-600 font-semibold shadow-md transition duration-150 ease-in-out">
        <i class="fa-solid fa-user-injured w-5 h-5"></i>
        <span>Patients</span>
    </a>
    <a href="{% url 'admin_confirmed_appointments' %}" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out">
        <i class="fa-solid fa-calendar-check w-5 h-5"></i>
        <span>Rendez-vous Confirmés</span>
    </a>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto bg-white shadow-2xl rounded-3xl p-8 border border-gray-100">
  <h1 class="text-3xl font-extrabold text-gray-800 mb-8 flex items-center border-b pb-4">
    <i class="fa-solid fa-users text-blue-500 mr-3"></i> Liste des Patients
  </h1>

  {% if messages %}
    {% for message in messages %}
      <div class="p-4 mb-4 text-sm rounded-lg 
        {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-200{% else %}bg-blue-100 text-blue-800 border border-blue-200{% endif %}" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <div class="mb-6 flex justify-end">
    <a href="{% url 'admin_add_user' %}" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-150 ease-in-out shadow-lg flex items-center space-x-2">
        <i class="fa-solid fa-user-plus"></i>
        <span>Ajouter un Patient</span>
    </a>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom d'utilisateur</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom complet</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Âge</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Téléphone
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adresse</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
  {% for patient in patients %}
  <tr id="row-{{ patient.id }}" class="hover:bg-emerald-50 transition duration-150 ease-in-out">
    <!-- username -->
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
      <span class="txt">{{ patient.username }}</span>
      <span class="inp hidden" data-name="username">{{ patient.username }}</span>
    </td>

    <!-- full_name -->
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
      <span class="txt">{{ patient.patient_profile.full_name }}</span>
      <span class="inp hidden" data-name="full_name">{{ patient.patient_profile.full_name }}</span>
    </td>

    <!-- email -->
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
      <span class="txt">{{ patient.email }}</span>
      <span class="inp hidden" data-name="email">{{ patient.email }}</span>
    </td>

    <!-- age -->
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
      <span class="txt">{{ patient.patient_profile.age }}</span>
      <span class="inp hidden" data-name="age">{{ patient.patient_profile.age }}</span>
    </td>

    <!-- phone -->
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
      <span class="txt">{{ patient.patient_profile.phone }}</span>
      <span class="inp hidden" data-name="phone">{{ patient.patient_profile.phone }}</span>
    </td>

    <!-- address -->
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
      <span class="txt">{{ patient.patient_profile.address }}</span>
      <span class="inp hidden" data-name="address">{{ patient.patient_profile.address }}</span>
    </td>

    <!-- ACTIONS -->
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
  <!-- MODIFICATION -->
  <form method="post" action="{% url 'edit_patient_inline' patient.patient_profile.id %}" class="inline" onsubmit="fillHiddenFields(this, {{ patient.id }})">
  {% csrf_token %}

  <!-- Champs cachés : on laisse vide, on remplit à la volée -->
  <input type="hidden" name="username">
  <input type="hidden" name="full_name">
  <input type="hidden" name="email">
  <input type="hidden" name="age">
  <input type="hidden" name="phone">
  <input type="hidden" name="address">

  <button type="button" class="edit-btn text-blue-600 hover:text-blue-900 mr-2"
          onclick="toggleEdit({{ patient.id }})">
    <i class="fa-solid fa-pen-to-square"></i> Modifier
  </button>
  <button type="submit" class="save-btn hidden text-green-600 hover:text-green-900 mr-2">
    <i class="fa-solid fa-check"></i> Sauvegarder
  </button>
</form>

  <!-- SUPPRESSION -->
  <form method="post" action="{% url 'delete_patient_inline' patient.patient_profile.id %}" class="inline">
    {% csrf_token %}
    <button type="submit" class="text-red-600 hover:text-red-900 text-sm"
            onclick="return confirm('Voulez-vous vraiment supprimer ce patient ?');">
      <i class="fa-solid fa-trash"></i> Supprimer
    </button>
  </form>
</td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="7" class="text-center py-8 text-lg text-gray-500 bg-gray-50 rounded-b-xl">
      <i class="fa-solid fa-circle-info mr-2 text-xl text-gray-400"></i>
      Aucun patient trouvé.
    </td>
  </tr>
  {% endfor %}
</tbody>
    </table>
  </div>

  <div class="mt-8 text-right">
    <a href="{% url 'admin_dashboard' %}" class="text-emerald-600 font-semibold hover:text-emerald-800 transition duration-150 ease-in-out flex items-center justify-end space-x-2">
        <i class="fa-solid fa-arrow-left"></i>
        <span>Retour au tableau de bord</span>
    </a>
  </div>
</div>
<script>
function toggleEdit(id) {
  const row = document.getElementById('row-' + id);
  row.querySelectorAll('.txt').forEach(el => el.classList.add('hidden'));
  row.querySelectorAll('.inp').forEach(el => {
    el.classList.remove('hidden');
    const inp = document.createElement('input');
    inp.type = el.dataset.name === 'age' ? 'number' : 'text';
    inp.value = el.textContent.trim();
    el.innerHTML = '';
    el.appendChild(inp);
  });
  row.querySelector('.edit-btn').classList.add('hidden');
  row.querySelector('.save-btn').classList.remove('hidden');
}
function fillHiddenFields(form, id) {
  const row = document.getElementById('row-' + id);
  row.querySelectorAll('.inp input').forEach(inp => {
    const field = form.querySelector('input[name="' + inp.parentElement.dataset.name + '"]');
    if (field) field.value = inp.value;
  });
}
</script>
{% endblock %}