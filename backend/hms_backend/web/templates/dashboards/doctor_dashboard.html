{% extends 'base.html' %}

{% block title %}Dashboard Docteur{% endblock %}

{% block header %}Tableau de bord Docteur{% endblock %}

{% block sidebar %}
    <!-- ‚úÖ Tableau de bord : toujours en vert sur cette page -->
    <a href="{% url 'doctor_dashboard' %}" 
       class="flex items-center space-x-3 p-3 rounded-lg text-white bg-emerald-600 font-semibold shadow-md transition duration-150 ease-in-out">
        <i class="fa-solid fa-gauge-high w-5 h-5"></i>
        <span>Tableau de bord</span>
    </a>

    <!-- Les autres liens restent gris√©s -->
    <a href="{% url 'doctor_finished_patients' %}" 
       class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out">
        <i class="fa-solid fa-user-check w-5 h-5"></i>
        <span>Mes Patients</span>
    </a>

    <a href="{% url 'doctor_weekly_schedule' %}" 
       class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition">
        <i class="fa-solid fa-calendar-week w-5 h-5"></i>
        <span>Mon Planning</span>
    </a>
    <!--
    <a href="{% url 'create_ordonnance' %}" 
       class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out">
        <i class="fa-solid fa-calendar-check w-5 h-5"></i>
        <span>Cr√©er Ordonnance</span>
    </a>

    <a href="{% url 'doctor_ordonnances' %}" 
       class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition">
        <i class="fa-solid fa-prescription-bottle-medical w-5 h-5"></i>
        <span>Mes Ordonnances</span>
    </a>
    -->
    <a href="{% url 'profile_info' %}" 
       class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out">
        <i class="fa-solid fa-user-gear w-5 h-5"></i>
        <span>Mon Profil</span>
    </a>
{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="max-w-full mx-auto">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-2">
        <i class="fa-solid fa-hand-wave text-emerald-500 mr-2"></i> Bonjour, Dr {{ doctor_name }} !
    </h1>
    <p class="text-lg text-gray-600 mb-10 border-b pb-4">
        Sp√©cialit√© : <strong class="text-blue-600">{{ doctor_specialization }}</strong>
    </p>

    <!-- üßæ Statistiques principales -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
        <div class="stat-card bg-white p-6 rounded-2xl shadow-xl border-l-4 border-blue-500 hover:shadow-2xl transition duration-300 ease-in-out">
            <div class="flex justify-between items-center">
                <div>
                    <div class="text-sm font-medium text-blue-500 uppercase tracking-wider">Patients totaux</div>
                    <div class="text-4xl font-bold text-gray-900 mt-1">{{ stats.total_patients }}</div>
                    <div class="text-xs text-gray-500 mt-2">Suivis par vous</div>
                </div>
                <div class="p-3 bg-blue-100 rounded-full text-blue-600">
                    <i class="fa-solid fa-users text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white p-6 rounded-2xl shadow-xl border-l-4 border-emerald-500 hover:shadow-2xl transition duration-300 ease-in-out">
            <div class="flex justify-between items-center">
                <div>
                    <div class="text-sm font-medium text-emerald-500 uppercase tracking-wider">RDV aujourd‚Äôhui</div>
                    <div class="text-4xl font-bold text-gray-900 mt-1">{{ stats.today_appointments }}</div>
                    <div class="text-xs text-gray-500 mt-2">Consultations planifi√©es</div>
                </div>
                <div class="p-3 bg-emerald-100 rounded-full text-emerald-600">
                    <i class="fa-solid fa-calendar-day text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white p-6 rounded-2xl shadow-xl border-l-4 border-purple-500 hover:shadow-2xl transition duration-300 ease-in-out">
            <div class="flex justify-between items-center">
                <div>
                    <div class="text-sm font-medium text-purple-500 uppercase tracking-wider">Nouveaux rapports</div>
                    <div class="text-4xl font-bold text-gray-900 mt-1">{{ stats.new_reports }}</div>
                    <div class="text-xs text-gray-500 mt-2">√Ä examiner</div>
                </div>
                <div class="p-3 bg-purple-100 rounded-full text-purple-600">
                    <i class="fa-solid fa-file-medical text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white p-6 rounded-2xl shadow-xl border-l-4 border-yellow-500 hover:shadow-2xl transition duration-300 ease-in-out">
            <div class="flex justify-between items-center">
                <div>
                    <div class="text-sm font-medium text-yellow-500 uppercase tracking-wider">Nouveaux patients</div>
                    <div class="text-4xl font-bold text-gray-900 mt-1">{{ stats.new_patients }}</div>
                    <div class="text-xs text-gray-500 mt-2">Ce mois-ci</div>
                </div>
                <div class="p-3 bg-yellow-100 rounded-full text-yellow-600">
                    <i class="fa-solid fa-user-plus text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

        <!-- üìÖ Tous les rendez-vous avec patients -->
    <div class="mt-10 bg-white p-8 rounded-2xl shadow-xl">
        <h2 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-3 flex items-center">
            <i class="fa-solid fa-calendar-days text-emerald-500 mr-3"></i> G√©rer mes rendez-vous
        </h2>

        {% if appointments_with_patients %}
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-xl shadow-sm">
                    <thead class="bg-emerald-50 text-gray-700">
                        <tr>
                            <th class="py-3 px-4 text-left">Date</th>
                            <th class="py-3 px-4 text-left">Heure</th>
                            <th class="py-3 px-4 text-left">Patient</th>
                            <th class="py-3 px-4 text-left">√Çge</th>
                            <th class="py-3 px-4 text-left">T√©l√©phone</th>
                            <th class="py-3 px-4 text-left">Motif</th>
                            <th class="py-3 px-4 text-left">Statut</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        {% for a in appointments_with_patients %}
                        <tr class="hover:bg-emerald-50 transition duration-150 ease-in-out">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ a.date }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ a.time }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ a.patient.full_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ a.patient.age }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ a.patient.phone }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ a.reason|truncatechars:40 }}</td>

                            <!-- PASTILLE COULEUR + BLOCAGE SI ANNUL√â OU TERMIN√â -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if a.status in 'COMPLETED,CANCELLED' %}
                                    <!-- Gris√© + inutilisable -->
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                                {% if a.status == 'COMPLETED' %}bg-gray-200 text-gray-700{% else %}bg-red-100 text-red-700{% endif %} select-none">
                                        {% if a.status == 'COMPLETED' %}Termin√©{% else %}Annul√©{% endif %}
                                    </span>
                                {% else %}
                                    <select onchange="changeStatus({{ a.id }}, this.value)"
                                            class="text-xs border rounded px-2 py-1 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500
                                            {% if a.status == 'PENDING' %}border-amber-400 text-amber-700
                                            {% elif a.status == 'CONFIRMED' %}border-green-400 text-green-700
                                            {% endif %}">
                                        <option value="PENDING"   {% if a.status == 'PENDING' %}selected{% endif %} class="bg-white text-amber-700">En attente</option>
                                        <option value="CONFIRMED" {% if a.status == 'CONFIRMED' %}selected{% endif %} class="bg-white text-green-700">Confirm√©</option>
                                        <option value="CANCELLED" {% if a.status == 'CANCELLED' %}selected{% endif %} class="bg-white text-red-700">Annul√©</option>
                                        <option value="COMPLETED" {% if a.status == 'COMPLETED' %}selected{% endif %} class="bg-white text-gray-700">Termin√©</option>
                                    </select>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-500 p-6 border border-dashed rounded-xl bg-gray-50 text-center shadow-inner">
                <i class="fa-solid fa-circle-info mr-2 text-xl text-gray-400"></i>
                Aucun rendez-vous trouv√©.
            </p>
        {% endif %}
    </div>

    <!-- üìÖ Mon Agenda (RDV confirm√©s) -->
    <div class="mt-10 bg-white p-8 rounded-2xl shadow-xl">
        <h2 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-3 flex items-center">
            <i class="fa-solid fa-calendar-check text-emerald-500 mr-3"></i> RDV confirm√©s
        </h2>

        {% if confirmed_appointments %}
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-xl shadow-sm">
                    <thead class="bg-emerald-50 text-gray-700">
                        <tr>
                            <th class="py-3 px-4 text-left">Date</th>
                            <th class="py-3 px-4 text-left">Heure</th>
                            <th class="py-3 px-4 text-left">Patient</th>
                            <th class="py-3 px-4 text-left">√Çge</th>
                            <th class="py-3 px-4 text-left">T√©l√©phone</th>
                            <th class="py-3 px-4 text-left">Motif</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for a in confirmed_appointments %}
                        <tr class="hover:bg-emerald-50 transition">
                            <td class="py-3 px-4">{{ a.date }}</td>
                            <td class="py-3 px-4">{{ a.time }}</td>
                            <td class="py-3 px-4 font-medium">{{ a.patient.full_name }}</td>
                            <td class="py-3 px-4">{{ a.patient.age }}</td>
                            <td class="py-3 px-4">{{ a.patient.phone }}</td>
                            <td class="py-3 px-4">{{ a.reason|truncatechars:50 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-500 p-6 border border-dashed rounded-xl bg-gray-50 text-center">
                <i class="fa-solid fa-circle-info mr-2 text-xl text-gray-400"></i>
                Aucun rendez-vous confirm√© pour le moment.
            </p>
        {% endif %}
    </div>

    <!-- RDV TERMIN√âS -->
    <div class="mt-10 bg-white p-8 rounded-2xl shadow-xl">
    <h2 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-3 flex items-center">
        <i class="fa-solid fa-check-double text-emerald-500 mr-3"></i> RDV Termin√©s
    </h2>

        {% if completed_appointments %}
            <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-xl shadow-sm">
                <thead class="bg-emerald-50 text-gray-700">
                <tr>
                    <th class="py-3 px-4 text-left">Date</th>
                    <th class="py-3 px-4 text-left">Heure</th>
                    <th class="py-3 px-4 text-left">Patient</th>
                    <th class="py-3 px-4 text-left">√Çge</th>
                    <th class="py-3 px-4 text-left">T√©lephone</th>
                    <th class="py-3 px-4 text-left">Motif</th>
                    <th class="py-3 px-4 text-left">Action</th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                {% for a in completed_appointments %}
                <tr class="hover:bg-emerald-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ a.date }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ a.time }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ a.patient.full_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ a.patient.age }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ a.patient.phone }}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">{{ a.reason|truncatechars:40 }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if a.ordonnance_created %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                            <i class="fa-solid fa-check mr-1"></i>Ordonnance cr√©√©e
                            </span>
                        {% else %}
                            <a href="{% url 'create_ordonnance_from_appointment' appointment_id=a.id %}"
                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow text-white bg-emerald-600 hover:bg-emerald-700">
                            <i class="fa-solid fa-file-prescription mr-1"></i> Cr√©er ordonnance
                            </a>
                        {% endif %}
                    
                        {% if a.certificat_created %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-emerald-800">
                            <i class="fa-solid fa-check mr-1"></i>Certificat cr√©√©
                        </span>
                        {% else %}
                        <a href="{% url 'create_certificat_from_appointment' appointment_id=a.id %}"
                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow text-white bg-emerald-600 hover:bg-emerald-700">
                            <i class="fa-solid fa-file-medical mr-1"></i> Cr√©er certificat
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>
        {% else %}
            <p class="text-gray-500 p-6 border border-dashed rounded-xl bg-gray-50 text-center">
            <i class="fa-solid fa-circle-info mr-2 text-xl text-gray-400"></i>
            Aucun RDV termin√© pour le moment.
            </p>
        {% endif %}
    </div>


        <!-- üö® Alertes -->
        <div class="mt-10 bg-white p-8 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-3 flex items-center">
                <i class="fa-solid fa-triangle-exclamation text-red-500 mr-3"></i> Alertes critiques
            </h2>
            {% if alerts %}
                <div class="space-y-4">
                    {% for a in alerts %}
                        <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-lg shadow-sm hover:shadow-md transition duration-150 ease-in-out">
                            <p class="font-bold text-red-700 flex justify-between items-center">
                                <span><i class="fa-solid fa-bell mr-2"></i> {{ a.type }}</span>
                                <span class="text-xs text-gray-500">{{ a.time }}</span>
                            </p>
                            <p class="text-sm text-gray-700 mt-1">Patient : <strong class="text-gray-900">{{ a.patient }}</strong></p>
                            <p class="text-sm text-gray-700">Valeur : {{ a.value }}</p>
                            <p class="text-sm text-gray-700">M√©dicament : {{ a.drug }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 p-6 border border-dashed rounded-xl bg-gray-50 text-center shadow-inner">
                    <i class="fa-solid fa-circle-check mr-2 text-xl text-green-500"></i>
                    Aucune alerte critique actuellement.
                </p>
            {% endif %}
        </div>
    </div>

    <!-- üìà Graphique -->
    <div class="mt-10 bg-white p-8 rounded-2xl shadow-xl">
        <h2 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-3 flex items-center">
            <i class="fa-solid fa-chart-line text-blue-500 mr-3"></i> Performance hebdomadaire
        </h2>
        <div class="p-4 rounded-xl border border-gray-200">
            <canvas id="weeklyChart" height="100"></canvas>
        </div>
    </div>
</div>
<!--
<script>
  const ctx = document.getElementById('weeklyChart');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [{% for d in weekly_performance_data %}'{{ d.day }}'{% if not forloop.last %},{% endif %}{% endfor %}],
      datasets: [{
        label: 'Patients vus',
        data: [{% for d in weekly_performance_data %}{{ d.patients }}{% if not forloop.last %},{% endif %}{% endfor %}],
        backgroundColor: 'rgba(16, 185, 129, 0.8)', // emerald-500
        borderColor: 'rgba(16, 185, 129, 1)',
        borderWidth: 1,
        borderRadius: 6,
      }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: 'Nombre de patients vus par jour'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)',
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
  });
</script>-->
<script>
async function changeStatus(appointmentId, newStatus) {
  const res = await fetch(`/api/users/appointments/${appointmentId}/status/`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}',
      'Authorization': 'Bearer {{ request.session.access_token }}'
    },
    body: JSON.stringify({ status: newStatus })
  });

  if (res.ok) {
    location.reload(); // ou mets √† jour le DOM en JS si tu veux √©viter le reload
  } else {
    alert("Erreur lors du changement de statut.");
  }
}
</script>
{%¬†endblock¬†%}